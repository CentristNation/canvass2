<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Canvassing Command Center</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Base Styles */
        #map { 
            height: 300px;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            #map { height: 400px; }
        }
        
        @media (min-width: 992px) {
            #map { height: 500px; }
        }
        
        .voter-card { 
            border-left: 4px solid #007bff; 
            margin-bottom: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .voter-card.visited { border-left-color: #28a745; background-color: #f8f9fa; }
        .voter-card.current { border-left-color: #ffc107; background-color: #fff3cd; }
        .voter-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .canvasser-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 0.85rem;
            max-width: 200px;
        }
        
        @media (max-width: 767px) {
            .canvasser-status {
                top: 5px;
                right: 5px;
                left: 5px;
                max-width: none;
                font-size: 0.8rem;
                padding: 6px 8px;
            }
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        /* Mobile optimizations for field work */
        @media (max-width: 767px) {
            .container-fluid { padding: 0.25rem; }
            .card-body { padding: 0.5rem; }
            .voter-card .card-body { padding: 0.4rem; }
            .btn-sm { 
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
                min-height: 44px;
            }
            .form-select-sm, .form-control { 
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
                min-height: 44px;
            }
            .summary-card { padding: 8px; }
            .mobile-stack { margin-bottom: 0.75rem; }
            .form-check-input { 
                transform: scale(1.3);
                margin-right: 0.5rem;
            }
            
            /* Larger touch targets for mobile */
            .btn { 
                min-height: 48px;
                font-size: 0.9rem;
            }
            
            /* Better spacing on mobile */
            .main-content { padding-top: 70px; }
            
            /* Enhanced message panel for mobile */
            .canvasser-status {
                position: fixed;
                top: 60px;
                left: 5px;
                right: 5px;
                max-width: none;
                font-size: 0.75rem;
                padding: 5px 8px;
                background: rgba(0,0,0,0.95);
                border-radius: 6px;
                z-index: 1000;
            }
        }

        /* GPS Status Indicators */
        .gps-status {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
        }

        .gps-status.good { background: rgba(40, 167, 69, 0.9); }
        .gps-status.warning { background: rgba(255, 193, 7, 0.9); color: black; }
        .gps-status.error { background: rgba(220, 53, 69, 0.9); }

        /* Proximity validation */
        .proximity-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .proximity-good {
            background: #d1e7dd;
            border: 1px solid #a3cfbb;
            color: #0f5132;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* Location path tracking */
        .location-log {
            font-size: 0.75rem;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        /* Party color indicators */
        .party-republican { border-left-color: #dc3545 !important; }
        .party-democrat { border-left-color: #007bff !important; }
        .party-independent { border-left-color: #6c757d !important; }
        
        /* Legend */
        .map-legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #fff;
        }

        /* Dashboard specific styles */
        .dashboard-switcher {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
        }

        /* Field Dashboard - Clean mobile interface */
        .field-dashboard .main-content {
            padding-top: 60px;
        }

        .field-dashboard .current-assignment {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Admin Dashboard - Full monitoring interface */
        .admin-dashboard {
            background: #f8f9fa;
        }

        .canvasser-tracker {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .canvasser-tracker.active {
            border-left-color: #28a745;
            background: #f8fff9;
        }

        .canvasser-tracker.inactive {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .real-time-stats {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
        }

        /* Hide/Show based on dashboard mode */
        .field-only { display: none; }
        .admin-only { display: none; }
        
        .field-dashboard .field-only { display: block; }
        .admin-dashboard .admin-only { display: block; }

        /* Voter list modal for field view */
        .voter-list-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="field-dashboard">
    <!-- Dashboard Switcher -->
    <div class="dashboard-switcher">
        <div class="btn-group" role="group">
            <button class="btn btn-sm btn-primary" onclick="switchToField()" id="fieldBtn">
                <i class="fas fa-mobile-alt"></i> Field
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="switchToAdmin()" id="adminBtn">
                <i class="fas fa-desktop"></i> Admin
            </button>
        </div>
    </div>

    <!-- Canvasser Status (Field View) -->
    <div class="canvasser-status field-only">
        <div><i class="fas fa-user"></i> <span id="canvasserName">Demo User</span></div>
        <div><i class="fas fa-location-dot"></i> Status: <span id="locationStatus">Searching...</span></div>
        <div><i class="fas fa-clock"></i> Last Update: <span id="lastUpdateTime">--</span></div>
    </div>

    <div class="container-fluid">
        <!-- =========================== FIELD DASHBOARD =========================== -->
        <div class="field-only">
            <!-- Field Header -->
            <nav class="navbar navbar-dark bg-success mb-3 fixed-top">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">
                        <i class="fas fa-door-open"></i> Field Canvassing
                    </span>
                    <div>
                        <button class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#filterModal">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#voterListModal">
                            <i class="fas fa-list"></i> My List
                        </button>
                    </div>
                </div>
            </nav>

            <div class="main-content">
                <!-- Assignment Info -->
                <div class="card mb-3" style="background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%); color: white;">
                    <div class="card-body">
                        <h6><i class="fas fa-clipboard-list"></i> Today's Assignment</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h5" id="assignedCount">156</div>
                                <small>Assigned</small>
                            </div>
                            <div class="col-4">
                                <div class="h5" id="fieldVisitedCount">23</div>
                                <small>Completed</small>
                            </div>
                            <div class="col-4">
                                <div class="h5" id="fieldProgressPercent">15%</div>
                                <small>Progress</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Panel -->
                <div class="card mb-3" id="messagesPanel" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-bell text-warning"></i> New Message</h6>
                        <button class="btn btn-sm btn-outline-danger" onclick="dismissMessage()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="card-body" id="messageContent">
                        <!-- Message content -->
                    </div>
                </div>
                <!-- Current Assignment -->
                <div class="current-assignment" id="currentAssignment" style="display: none;">
                    <h6><i class="fas fa-crosshairs"></i> Current Assignment</h6>
                    <div id="currentVoterInfo"></div>
                    <div class="mt-2">
                        <button class="btn btn-light btn-sm" onclick="getDirections()">
                            <i class="fas fa-route"></i> Get Directions
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="markNotHome()">
                            <i class="fas fa-home"></i> Not Home
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mb-3">
                    <div class="col-4">
                        <button class="btn btn-primary w-100" onclick="findNearestVoter()">
                            <i class="fas fa-location-arrow"></i><br>
                            <small>Find Nearest</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-success w-100" onclick="startLocationTracking()" id="trackingBtn">
                            <i class="fas fa-play"></i><br>
                            <small>Start Tracking</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-info w-100" onclick="showLocationLog()">
                            <i class="fas fa-history"></i><br>
                            <small>Location Log</small>
                        </button>
                    </div>
                </div>

                <!-- Compact Map -->
                <div class="card mb-3">
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>

                <!-- Notes Form -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-pen"></i> Visit Notes</h6>
                    </div>
                    <div class="card-body">
                        <!-- Location Validation -->
                        <div id="locationValidation" class="proximity-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Location Required:</strong> You must be within 1000 feet of the voter address to complete this form.
                        </div>

                        <form id="notesForm">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="present">
                                        <label class="form-check-label" for="present">Present</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="willVote">
                                        <label class="form-check-label" for="willVote">Will Vote</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="nextTime">
                                        <label class="form-check-label" for="nextTime">Next Time</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" id="voterNotes" rows="3" placeholder="Conversation notes..."></textarea>
                            </div>
                            <div class="mb-3">
                                <select class="form-select" id="supportLevel">
                                    <option value="">Support Level...</option>
                                    <option value="strong-support">Strong Support</option>
                                    <option value="lean-support">Lean Support</option>
                                    <option value="undecided">Undecided</option>
                                    <option value="lean-oppose">Lean Oppose</option>
                                    <option value="strong-oppose">Strong Oppose</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success w-100" id="submitBtn" disabled>
                                <i class="fas fa-save"></i> Complete Visit
                            </button>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> Form will be enabled when you're within 1000 feet of the address.
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- =========================== ADMIN DASHBOARD =========================== -->
        <div class="admin-only">
            <!-- Admin Header -->
            <nav class="navbar navbar-dark bg-primary mb-3">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">
                        <i class="fas fa-chart-line"></i> Campaign Control Center
                    </span>
                    <span class="navbar-text">
                        <i class="fas fa-users"></i> <span id="totalVoters">0</span> Voters | 
                        <i class="fas fa-check"></i> <span id="visitedCount">0</span> Visited
                    </span>
                </div>
            </nav>

            <div class="row">
                <!-- Left Panel - Assignment Management -->
                <div class="col-lg-4">
                    <!-- Assignment Control -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-tasks"></i> Assignment Management</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small">Total Voters to Assign</label>
                                <input type="number" class="form-control form-control-sm" id="totalToAssign" value="1000" min="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Active Field Workers</label>
                                <input type="number" class="form-control form-control-sm" id="activeWorkers" value="10" min="1">
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">
                                    Per worker: <span id="perWorkerCount">100</span> voters
                                </small>
                            </div>
                            <button class="btn btn-primary btn-sm w-100 mb-2" onclick="assignVotersToWorkers()">
                                <i class="fas fa-share-alt"></i> Assign to Workers
                            </button>
                            <button class="btn btn-outline-info btn-sm w-100" onclick="exportToGoogleSheets()">
                                <i class="fas fa-table"></i> Export to Sheets
                            </button>
                        </div>
                    </div>

                    <!-- Canvasser Tracking -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-users"></i> Field Workers <span class="badge bg-success" id="activeWorkersCount">1</span></h6>
                        </div>
                        <div class="card-body" style="max-height: 300px; overflow-y: auto;" id="canvasserTracking">
                            <!-- Canvasser tracking cards -->
                        </div>
                    </div>

                    <!-- Send Message -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-paper-plane"></i> Send Message</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <select class="form-select form-select-sm" id="messageTarget">
                                    <option value="all">All Workers</option>
                                    <option value="1">Demo User</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <textarea class="form-control form-control-sm" id="messageText" rows="2" placeholder="Type your message..."></textarea>
                            </div>
                            <button class="btn btn-primary btn-sm w-100" onclick="sendMessage()">
                                <i class="fas fa-send"></i> Send Message
                            </button>
                        </div>
                    </div>

                    <!-- Real-time Stats -->
                    <div class="real-time-stats">
                        <h6><i class="fas fa-bolt"></i> Live Performance</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="h4" id="activeCanvassers">1</div>
                                <small>Active</small>
                            </div>
                            <div class="col-4">
                                <div class="h4" id="hourlyRate">12</div>
                                <small>Per Hour</small>
                            </div>
                            <div class="col-4">
                                <div class="h4" id="completionRate">15%</div>
                                <small>Complete</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Center Panel - Map & Voter List -->
                <div class="col-lg-4">
                    <!-- Filters -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-filter"></i> Filters</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select form-select-sm" id="zipFilter" onchange="applyFilters()">
                                        <option value="">All Zips</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select form-select-sm" id="partyFilter" onchange="applyFilters()">
                                        <option value="">All Parties</option>
                                        <option value="Democrat">Democrat</option>
                                        <option value="Republican">Republican</option>
                                        <option value="Independent">Independent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-6">
                                    <select class="form-select form-select-sm" id="streetFilter" onchange="applyFilters()">
                                        <option value="">All Streets</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select form-select-sm" id="precinctFilter" onchange="applyFilters()">
                                        <option value="">All Precincts</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-8">
                                    <select class="form-select form-select-sm" id="statusFilter" onchange="applyFilters()">
                                        <option value="">All Status</option>
                                        <option value="visited">Visited</option>
                                        <option value="not-visited">Not Visited</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Voter List (Admin) -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-list"></i> Voter List <span class="badge bg-secondary" id="listCount">0</span></h6>
                        </div>
                        <div class="card-body" style="max-height: 200px; overflow-y: auto;" id="voterList">
                            <!-- Voter cards -->
                        </div>
                    </div>

                    <!-- Admin Map -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-map"></i> Territory Map</h6>
                            <small class="text-muted">Party Colors</small>
                        </div>
                        <div class="card-body p-0 position-relative">
                            <div id="map"></div>
                            <!-- Map Legend -->
                            <div class="map-legend position-absolute" style="bottom: 10px; left: 10px; z-index: 1000;">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #dc3545;"></div>
                                    <span>Republican</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #007bff;"></div>
                                    <span>Democrat</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #6c757d;"></div>
                                    <span>Independent</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Reports & Message Log -->
                <div class="col-lg-4">
                    <!-- Individual Worker Reports -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-user-chart"></i> Worker Performance</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <select class="form-select form-select-sm" id="workerSelect" onchange="generateWorkerReport()">
                                    <option value="">Select Worker...</option>
                                    <option value="1">Demo User</option>
                                </select>
                            </div>
                            <div id="workerReport">
                                <p class="text-muted">Select a worker to view their performance report.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Message Log -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-comments"></i> Message Log</h6>
                        </div>
                        <div class="card-body" style="max-height: 200px; overflow-y: auto;" id="messageLog">
                            <p class="text-muted">No messages sent yet.</p>
                        </div>
                    </div>

                    <!-- Campaign Summary -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Campaign Summary</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="generateSummary()">
                                <i class="fas fa-refresh"></i> Update
                            </button>
                        </div>
                        <div class="card-body" id="summaryContent">
                            <p class="text-muted">Click "Update" to generate summary</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Filter Modal for Field View -->
    <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-filter"></i> Filter My Assignments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Party</label>
                            <select class="form-select form-select-sm" id="fieldPartyFilter">
                                <option value="">All Parties</option>
                                <option value="Democrat">Democrat</option>
                                <option value="Republican">Republican</option>
                                <option value="Independent">Independent</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Status</label>
                            <select class="form-select form-select-sm" id="fieldStatusFilter">
                                <option value="">All Status</option>
                                <option value="visited">Completed</option>
                                <option value="not-visited">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <label class="form-label small">Precinct</label>
                            <select class="form-select form-select-sm" id="fieldPrecinctFilter">
                                <option value="">All Precincts</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Age Group</label>
                            <select class="form-select form-select-sm" id="fieldAgeFilter">
                                <option value="">All Ages</option>
                                <option value="18-25">18-25</option>
                                <option value="26-35">26-35</option>
                                <option value="36-45">36-45</option>
                                <option value="46-55">46-55</option>
                                <option value="56-65">56-65</option>
                                <option value="65+">65+</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <label class="form-label small">Race/Ethnicity</label>
                            <select class="form-select form-select-sm" id="fieldRaceFilter">
                                <option value="">All Races</option>
                                <option value="White">White</option>
                                <option value="Hispanic">Hispanic/Latino</option>
                                <option value="Black">Black/African American</option>
                                <option value="Asian">Asian</option>
                                <option value="Native American">Native American</option>
                                <option value="Pacific Islander">Pacific Islander</option>
                                <option value="Mixed">Mixed Race</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Gender</label>
                            <select class="form-select form-select-sm" id="fieldGenderFilter">
                                <option value="">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Non-binary">Non-binary</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-6">
                            <label class="form-label small">Street</label>
                            <select class="form-select form-select-sm" id="fieldStreetFilter">
                                <option value="">All Streets</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Zip Code</label>
                            <select class="form-select form-select-sm" id="fieldZipFilter">
                                <option value="">All Zips</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFieldFilters()">Clear All</button>
                    <button type="button" class="btn btn-primary" onclick="applyFieldFilters()" data-bs-dismiss="modal">Apply Filters</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Log Modal -->
    <div class="modal fade" id="locationLogModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-map-marked-alt"></i> Location & Time Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Total Distance:</strong> <span id="totalDistance">0.0 km</span>
                        </div>
                        <div class="col-6">
                            <strong>Total Time:</strong> <span id="totalTime">0 minutes</span>
                        </div>
                    </div>
                    <div id="locationLogContent" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted">Start location tracking to see your path log.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-info" onclick="exportLocationData()">
                        <i class="fas fa-download"></i> Export KML
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Voter List Modal for Field View -->
    <div class="modal fade voter-list-modal" id="voterListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-list"></i> My Assigned Voters</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Quick Stats -->
                    <div class="row mb-3">
                        <div class="col-4 text-center">
                            <div class="h5 text-primary" id="modalAssignedCount">156</div>
                            <small class="text-muted">Assigned</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="h5 text-success" id="modalCompletedCount">23</div>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="col-4 text-center">
                            <div class="h5 text-warning" id="modalPendingCount">133</div>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                    
                    <!-- Quick Filters -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <select class="form-select form-select-sm" id="modalPartyFilter" onchange="applyModalFilters()">
                                <option value="">All Parties</option>
                                <option value="Democrat">Democrat</option>
                                <option value="Republican">Republican</option>
                                <option value="Independent">Independent</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <select class="form-select form-select-sm" id="modalStatusFilter" onchange="applyModalFilters()">
                                <option value="">All Status</option>
                                <option value="visited">Completed</option>
                                <option value="not-visited">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div id="modalVoterList">
                        <!-- Modal voter list -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Permission Modal -->
    <div class="modal fade" id="locationPermissionModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Location Access Required</h5>
                </div>
                <div class="modal-body text-center">
                    <p><strong>This canvassing app requires location access to:</strong></p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-map-marker-alt text-primary"></i> Verify you're at voter addresses</li>
                        <li><i class="fas fa-route text-success"></i> Track your canvassing route</li>
                        <li><i class="fas fa-shield-alt text-info"></i> Ensure visit authenticity</li>
                    </ul>
                    <p class="text-muted">Please enable location access in your browser settings and try again.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="requestLocationPermission()">Try Again</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.reload()">Refresh Page</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <script>
        // Global variables
        let map;
        let votersData = [];
        let filteredVoters = [];
        let currentVoter = null;
        let canvasserLocation = null;
        let locationWatchId = null;
        let markers = {};
        let canvasserMarker = null;
        let proximityCircle = null; // New global variable for the proximity circle
        let currentVoterMarker = null; // New global variable for the selected voter marker
        let isDashboardField = true;
        let isLocationSharingActive = false;
        let locationPath = [];
        let totalPathDistance = 0;
        let lastLocationUpdate = null;
        let locationLog = [];
        const PROXIMITY_THRESHOLD_M = 304.8; // 1000 feet in meters

        // Simulated canvassers for admin view
        let canvassers = [
            {
                id: 1,
                name: "Demo User",
                status: "active",
                currentVoter: null,
                location: { lat: 33.17854842488629, lng: -96.78402904191564 },
                todayVisits: 0,
                assignedVoters: [],
                lastUpdate: new Date()
            }
        ];

        // Message system
        let messageLog = [];
        let currentUserId = 1; // Simulated current field worker ID

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            generateDemoData();
            populateFilters();
            applyFilters();
            updateCounts();
            updateCanvasserTracking();
            updateFieldAssignmentInfo();
            
            // Immediately request location permission on page load
            requestLocationPermission();
            
            // Initialize some demo assignments for testing
            setTimeout(() => {
                createDemoAssignments();
            }, 500);
        });

        // Request location permission - triggered automatically on page load
        function requestLocationPermission() {
            if (!navigator.geolocation) {
                showNotification('GPS not supported on this device', 'error');
                showLocationPermissionModal(); // Show modal if not supported
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Success - location permission granted
                    canvasserLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date()
                    };
                    
                    onLocationPermissionGranted();
                },
                function(error) {
                    handleLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        function onLocationPermissionGranted() {
            // Update status
            updateGPSStatus(`Location enabled`, 'good');
            
            // Show success message
            showNotification('Location services enabled! Please click Start Tracking to begin.', 'success');
            
            // Update canvasser marker on map
            updateCanvasserMarker();
        }

        function showLocationPermissionModal() {
            const modal = new bootstrap.Modal(document.getElementById('locationPermissionModal'));
            modal.show();
        }

        function handleLocationError(error) {
            let errorMessage = 'Location error: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Permission denied. Please enable location access.';
                    updateGPSStatus('Permission denied', 'error');
                    showLocationPermissionModal(); // Show the modal on permission denial
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location unavailable.';
                    updateGPSStatus('Location unavailable', 'error');
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location timeout.';
                    updateGPSStatus('GPS timeout', 'warning');
                    break;
                default:
                    errorMessage += 'Unknown location error.';
                    updateGPSStatus('GPS error', 'error');
                    break;
            }
            showNotification(errorMessage, 'error');
        }

        // Create demo assignments for testing
        function createDemoAssignments() {
            // Assign first 50 voters to current user for testing
            const unassignedVoters = votersData.filter(v => !v.assignedTo).slice(0, 50);
            unassignedVoters.forEach(voter => {
                voter.assignedTo = currentUserId;
            });

            // Update worker's assigned list
            const currentWorker = canvassers.find(w => w.id === currentUserId);
            if (currentWorker) {
                currentWorker.assignedVoters = unassignedVoters.map(v => v.id);
            }
            
            updateFieldAssignmentInfo();
            // Show assigned voters on map by default
            applyFilters();
            showNotification(`${unassignedVoters.length} voters assigned for demo purposes`, 'info');
        }

        // ========================== ENHANCED LOCATION SERVICES ==========================
        function startLocationTracking() {
            if (isLocationSharingActive) {
                stopLocationTracking();
                return;
            }
            if (!navigator.geolocation) {
                showNotification('GPS not available on this device', 'error');
                return;
            }
            isLocationSharingActive = true;
            locationPath = [];
            totalPathDistance = 0;
            updateGPSStatus('Tracking active', 'good');
            const trackingBtn = document.getElementById('trackingBtn');
            trackingBtn.innerHTML = '<i class="fas fa-stop"></i><br><small>Stop Tracking</small>';
            trackingBtn.classList.remove('btn-success');
            trackingBtn.classList.add('btn-danger');

            // Start high-accuracy GPS tracking
            locationWatchId = navigator.geolocation.watchPosition(
                handleLocationUpdate,
                handleLocationError,
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 1000
                }
            );

            showNotification('Location tracking started', 'success');
        }

        function stopLocationTracking() {
            if (!isLocationSharingActive) return;
            isLocationSharingActive = false;
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            updateGPSStatus('Tracking stopped', 'warning');
            const trackingBtn = document.getElementById('trackingBtn');
            trackingBtn.innerHTML = '<i class="fas fa-play"></i><br><small>Start Tracking</small>';
            trackingBtn.classList.remove('btn-danger');
            trackingBtn.classList.add('btn-success');

            showNotification('Location tracking stopped', 'info');
        }
        
        // This function handles every new location update
        function handleLocationUpdate(position) {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date(),
                speed: position.coords.speed || 0
            };

            // Calculate distance from last position if it exists
            if (canvasserLocation) {
                const distance = calculateDistance(
                    canvasserLocation.lat,
                    canvasserLocation.lng,
                    newLocation.lat,
                    newLocation.lng
                ) * 1000; // Convert to meters
                totalPathDistance += distance / 1000; // Convert to km
                locationPath.push({ lat: newLocation.lat, lng: newLocation.lng, timestamp: newLocation.timestamp, accuracy: newLocation.accuracy });
            }
            
            canvasserLocation = newLocation;
            
            // Update accuracy and last update time status
            const accuracyMessage = `Accuracy: ${Math.round(newLocation.accuracy)}m`;
            if (newLocation.accuracy > 50) {
                updateGPSStatus(`Low accuracy (${Math.round(newLocation.accuracy)}m)`, 'warning');
            } else {
                updateGPSStatus(`Good accuracy (${Math.round(newLocation.accuracy)}m)`, 'good');
            }
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
            
            // Update canvasser marker and proximity circle on the map
            updateCanvasserMarker();

            // Check proximity to current voter and update form
            checkProximityToCurrentVoter();
        }

        function checkProximityToCurrentVoter() {
            const proximityAlert = document.getElementById('locationValidation');
            const submitBtn = document.getElementById('submitBtn');

            if (!currentVoter || !canvasserLocation) {
                submitBtn.disabled = true;
                submitBtn.className = 'btn btn-secondary w-100';
                if(proximityAlert) proximityAlert.style.display = 'block';
                return;
            }

            const distance = calculateDistance(
                canvasserLocation.lat,
                canvasserLocation.lng,
                currentVoter.lat,
                currentVoter.lng
            ) * 1000; // Convert to meters
            
            if (distance <= PROXIMITY_THRESHOLD_M) {
                // Within proximity - enable form
                submitBtn.disabled = false;
                submitBtn.className = 'btn btn-success w-100';
                proximityAlert.className = 'proximity-good';
                proximityAlert.innerHTML = `<i class="fas fa-check-circle"></i> <strong>Location Confirmed:</strong> You are ${Math.round(distance)}m away.`;
            } else {
                // Outside proximity - disable form
                submitBtn.disabled = true;
                submitBtn.className = 'btn btn-secondary w-100';
                proximityAlert.className = 'proximity-warning';
                proximityAlert.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Location Required:</strong> You are ${Math.round(distance)}m away. Move within 1000 feet to enable form.`;
            }
            
            proximityAlert.style.display = 'block';
        }

        function updateGPSStatus(message, status) {
            const statusText = document.getElementById('locationStatus');
            const statusDiv = document.querySelector('.canvasser-status');
            if (statusText) statusText.textContent = message;
        }

        function showLocationLog() {
            const modal = new bootstrap.Modal(document.getElementById('locationLogModal'));
            const logContent = document.getElementById('locationLogContent');
            logContent.innerHTML = ''; // Clear previous log
            
            if (locationPath.length === 0) {
                 logContent.innerHTML = '<p class="text-muted">No location data has been recorded yet.</p>';
            } else {
                locationPath.forEach(entry => {
                    const logItem = document.createElement('div');
                    logItem.className = 'location-log';
                    logItem.innerHTML = `
                        <strong>${new Date(entry.timestamp).toLocaleTimeString()}</strong>
                        <br>
                        <small>Lat: ${entry.lat.toFixed(4)}, Lng: ${entry.lng.toFixed(4)} (Accuracy: ${Math.round(entry.accuracy)}m)</small>
                    `;
                    logContent.appendChild(logItem);
                });
            }

            document.getElementById('totalDistance').textContent = totalPathDistance.toFixed(2) + ' km';
            document.getElementById('totalTime').textContent = Math.round((new Date() - (locationPath[0] ? new Date(locationPath[0].timestamp) : new Date())) / 60000) + ' minutes';
            modal.show();
        }

        function exportLocationData() {
            if (locationPath.length === 0) {
                showNotification('No location data to export.', 'warning');
                return;
            }
            
            const kmlHeader = '<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<name>Canvasser Path</name>\n<Placemark>\n<name>Path</name>\n<LineString>\n<coordinates>\n';
            const kmlFooter = '</coordinates>\n</LineString>\n</Placemark>\n</Document>\n</kml>';
            
            const coordinates = locationPath.map(p => `${p.lng},${p.lat},0`).join('\n');
            const kmlContent = kmlHeader + coordinates + kmlFooter;
            
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `canvasser_path_${new Date().toISOString()}.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('KML file exported successfully!', 'success');
        }

        // ========================== LEAFLET MAP & DATA MANAGEMENT ==========================
        function initializeMap() {
            // Check if map container exists and has an id
            const mapContainer = document.getElementById('map');
            if (!mapContainer || mapContainer.children.length > 0) {
                // Assuming the map is already initialized or doesn't exist.
                return;
            }

            map = L.map('map').setView([33.17854842488629, -96.78402904191564], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: ' OpenStreetMap contributors'
            }).addTo(map);

            // Create the proximity circle layer, but don't add it to the map yet
            proximityCircle = L.circle([0, 0], {
                radius: PROXIMITY_THRESHOLD_M, // 1000 feet in meters
                color: 'blue',
                fillColor: '#3081e7',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '5, 5'
            });

            // Add a click listener to the map to select a voter
            map.on('click', function(e) {
                // Find nearest voter to the clicked point
                const clickedPoint = { lat: e.latlng.lat, lng: e.latlng.lng };
                let nearestVoter = null;
                let minDistance = Infinity;

                filteredVoters.forEach(voter => {
                    const distance = calculateDistance(
                        clickedPoint.lat, clickedPoint.lng,
                        voter.lat, voter.lng
                    );
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestVoter = voter;
                    }
                });

                if (nearestVoter && minDistance * 1000 < 100) { // Select if within 100 meters
                    selectVoter(nearestVoter.id);
                } else {
                    deselectVoter();
                }
            });
        }

        // Haversine formula to calculate distance between two lat/lng points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const toRad = (x) => x * Math.PI / 180;
            const R = 6371; // Radius of the Earth in km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        function generateDemoData() {
            votersData = [];
            const centerLat = 33.17854842488629;
            const centerLng = -96.78402904191564;
            const parties = ['Democrat', 'Republican', 'Independent'];
            const names = ['John Smith', 'Jane Doe', 'Peter Jones', 'Mary Williams', 'Robert Brown'];
            const streets = ['Elm St', 'Oak Ave', 'Maple Dr', 'Pine Ln', 'Cedar Rd'];
            const races = ['White', 'Hispanic', 'Black', 'Asian'];
            const genders = ['Male', 'Female'];
            const precincts = ['P101', 'P102', 'P103'];
            const zipCodes = ['75034', '75035', '75036'];
            
            for (let i = 0; i < 200; i++) {
                const lat = centerLat + (Math.random() - 0.5) * 0.02;
                const lng = centerLng + (Math.random() - 0.5) * 0.04;
                const isVisited = Math.random() < 0.2;

                votersData.push({
                    id: i + 1,
                    name: names[Math.floor(Math.random() * names.length)],
                    address: `${Math.floor(Math.random() * 2000) + 100} ${streets[Math.floor(Math.random() * streets.length)]}`,
                    party: parties[Math.floor(Math.random() * parties.length)],
                    status: isVisited ? 'visited' : 'not-visited',
                    notes: isVisited ? "Spoke with voter, very supportive." : "",
                    supportLevel: isVisited ? 'strong-support' : '',
                    lat: lat,
                    lng: lng,
                    assignedTo: null,
                    age: Math.floor(Math.random() * 70) + 18,
                    race: races[Math.floor(Math.random() * races.length)],
                    gender: genders[Math.floor(Math.random() * genders.length)],
                    precinct: precincts[Math.floor(Math.random() * precincts.length)],
                    zip: zipCodes[Math.floor(Math.random() * zipCodes.length)]
                });
            }
        }

        function populateFilters() {
            // Get unique values for dropdowns
            const uniqueZips = [...new Set(votersData.map(v => v.zip))];
            const uniqueStreets = [...new Set(votersData.map(v => v.address.split(' ').slice(1).join(' ')))];
            const uniquePrecincts = [...new Set(votersData.map(v => v.precinct))];

            populateDropdown('zipFilter', uniqueZips);
            populateDropdown('streetFilter', uniqueStreets);
            populateDropdown('precinctFilter', uniquePrecincts);
            populateDropdown('fieldPrecinctFilter', uniquePrecincts);
            populateDropdown('fieldStreetFilter', uniqueStreets);
            populateDropdown('fieldZipFilter', uniqueZips);
        }

        function populateDropdown(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            options.sort().forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
        }

        function applyFilters() {
            // Admin filters
            const party = document.getElementById('partyFilter').value;
            const status = document.getElementById('statusFilter').value;
            const street = document.getElementById('streetFilter').value;
            const zip = document.getElementById('zipFilter').value;
            const precinct = document.getElementById('precinctFilter').value;

            filteredVoters = votersData.filter(voter => {
                return (party === "" || voter.party === party) &&
                       (status === "" || voter.status === status) &&
                       (street === "" || voter.address.includes(street)) &&
                       (zip === "" || voter.zip === zip) &&
                       (precinct === "" || voter.precinct === precinct);
            });

            updateVoterListDisplay(filteredVoters, 'voterList');
            updateMarkers(filteredVoters);
            updateCounts();
        }
        
        function applyFieldFilters() {
            const party = document.getElementById('fieldPartyFilter').value;
            const status = document.getElementById('fieldStatusFilter').value;
            const precinct = document.getElementById('fieldPrecinctFilter').value;
            const ageGroup = document.getElementById('fieldAgeFilter').value;
            const race = document.getElementById('fieldRaceFilter').value;
            const gender = document.getElementById('fieldGenderFilter').value;
            const street = document.getElementById('fieldStreetFilter').value;
            const zip = document.getElementById('fieldZipFilter').value;

            // Get assigned voters for the current user
            const assignedVoters = votersData.filter(voter => voter.assignedTo === currentUserId);
            
            filteredVoters = assignedVoters.filter(voter => {
                let matchesAge = true;
                if (ageGroup !== "") {
                    const [min, max] = ageGroup.split('-').map(Number);
                    if (max) {
                        matchesAge = voter.age >= min && voter.age <= max;
                    } else {
                        matchesAge = voter.age >= min;
                    }
                }

                return (party === "" || voter.party === party) &&
                       (status === "" || voter.status === status) &&
                       (precinct === "" || voter.precinct === precinct) &&
                       (race === "" || voter.race === race) &&
                       (gender === "" || voter.gender === gender) &&
                       (street === "" || voter.address.includes(street)) &&
                       (zip === "" || voter.zip === zip) &&
                       matchesAge;
            });
            
            updateVoterListDisplay(filteredVoters, 'modalVoterList');
            updateMarkers(filteredVoters);
        }

        function clearFilters() {
            document.getElementById('partyFilter').value = "";
            document.getElementById('statusFilter').value = "";
            document.getElementById('streetFilter').value = "";
            document.getElementById('zipFilter').value = "";
            document.getElementById('precinctFilter').value = "";
            applyFilters();
        }

        function clearFieldFilters() {
            document.getElementById('fieldPartyFilter').value = "";
            document.getElementById('fieldStatusFilter').value = "";
            document.getElementById('fieldPrecinctFilter').value = "";
            document.getElementById('fieldAgeFilter').value = "";
            document.getElementById('fieldRaceFilter').value = "";
            document.getElementById('fieldGenderFilter').value = "";
            document.getElementById('fieldStreetFilter').value = "";
            document.getElementById('fieldZipFilter').value = "";
            applyFieldFilters();
        }

        function applyModalFilters() {
            const party = document.getElementById('modalPartyFilter').value;
            const status = document.getElementById('modalStatusFilter').value;
            const assignedVoters = votersData.filter(voter => voter.assignedTo === currentUserId);

            const modalFilteredVoters = assignedVoters.filter(voter => {
                return (party === "" || voter.party === party) &&
                       (status === "" || voter.status === status);
            });
            updateVoterListDisplay(modalFilteredVoters, 'modalVoterList');
            
            // Update modal counts
            const totalAssigned = assignedVoters.length;
            const completed = assignedVoters.filter(v => v.status === 'visited').length;
            const pending = totalAssigned - completed;
            document.getElementById('modalAssignedCount').textContent = totalAssigned;
            document.getElementById('modalCompletedCount').textContent = completed;
            document.getElementById('modalPendingCount').textContent = pending;
        }

        function updateVoterListDisplay(voters, containerId) {
            const listContainer = document.getElementById(containerId);
            listContainer.innerHTML = '';
            
            if (voters.length === 0) {
                listContainer.innerHTML = '<p class="text-muted text-center mt-3">No voters match the filters.</p>';
                document.getElementById('listCount').textContent = 0;
                return;
            }
            
            document.getElementById('listCount').textContent = voters.length;

            voters.forEach(voter => {
                const voterCard = document.createElement('div');
                voterCard.className = `card voter-card ${voter.status} party-${voter.party.toLowerCase()}`;
                voterCard.setAttribute('data-voter-id', voter.id);
                voterCard.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${voter.name}</h6>
                                <small class="text-muted">${voter.address}, ${voter.zip}</small>
                            </div>
                            <span class="badge ${voter.status === 'visited' ? 'bg-success' : 'bg-warning'} status-badge">
                                ${voter.status === 'visited' ? 'Visited' : 'Pending'}
                            </span>
                        </div>
                        <div class="mt-2">
                            <i class="fas fa-vote-yea text-${voter.party === 'Democrat' ? 'primary' : voter.party === 'Republican' ? 'danger' : 'secondary'}"></i> ${voter.party}
                            ${voter.supportLevel ? `<i class="fas fa-thumbs-up ms-2"></i> ${voter.supportLevel}` : ''}
                        </div>
                    </div>
                `;
                voterCard.addEventListener('click', () => selectVoter(voter.id));
                listContainer.appendChild(voterCard);
            });
        }

        function updateMarkers(voters) {
            // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};

            voters.forEach(voter => {
                const iconHtml = `<div style="text-align: center; color: ${voter.status === 'visited' ? '#28a745' : '#ffc107'}; font-size: 24px;">
                                    <i class="fas fa-home"></i>
                                  </div>`;

                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: iconHtml,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });

                const marker = L.marker([voter.lat, voter.lng], { icon: customIcon }).addTo(map);
                marker.bindPopup(`<b>${voter.name}</b><br>${voter.address}`);
                markers[voter.id] = marker;
            });

            // Update canvasser marker after voter markers
            updateCanvasserMarker();
            if (currentVoter) {
                 updateCurrentVoterMarker(currentVoter);
            }
        }

        function updateCanvasserMarker() {
            if (!canvasserLocation || !map) return;
            const iconHtml = `<div style="text-align: center; color: #007bff; font-size: 24px; animation: pulse 2s infinite;">
                                <i class="fas fa-user-circle"></i>
                              </div>
                              <style>
                                @keyframes pulse {
                                    0% { transform: scale(1); opacity: 1; }
                                    50% { transform: scale(1.2); opacity: 0.5; }
                                    100% { transform: scale(1); opacity: 1; }
                                }
                              </style>`;
            
            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: iconHtml,
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });
            
            const latLng = [canvasserLocation.lat, canvasserLocation.lng];
            if (canvasserMarker) {
                canvasserMarker.setLatLng(latLng);
            } else {
                canvasserMarker = L.marker(latLng, {
                    icon: customIcon
                }).addTo(map);
            }
            
            // Update the proximity circle's position
            if (proximityCircle) {
                proximityCircle.setLatLng(latLng).addTo(map);
            }
            
            map.panTo(latLng);
        }
        
        // Highlights the currently selected voter on the map
        function updateCurrentVoterMarker(voter) {
            // Remove previous marker if it exists
            if (currentVoterMarker) {
                map.removeLayer(currentVoterMarker);
            }
            
            if (voter) {
                const highlightIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="text-align: center; color: #ffc107; font-size: 32px; animation: pulse 2s infinite;">
                                <i class="fas fa-star"></i>
                           </div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                });
                currentVoterMarker = L.marker([voter.lat, voter.lng], { icon: highlightIcon }).addTo(map);
                currentVoterMarker.bindPopup(`<b>Currently Selected:</b><br>${voter.name}<br>${voter.address}`).openPopup();
            }
        }


        function selectVoter(voterId) {
            if (currentVoter) {
                const prevCard = document.querySelector(`.voter-card[data-voter-id="${currentVoter.id}"]`);
                if (prevCard) prevCard.classList.remove('current');
            }
            currentVoter = votersData.find(v => v.id === voterId);
            const newCard = document.querySelector(`.voter-card[data-voter-id="${voterId}"]`);
            if (newCard) newCard.classList.add('current');
            
            // Pan map to voter location
            map.panTo([currentVoter.lat, currentVoter.lng]);
            updateCurrentVoterMarker(currentVoter);

            // Update UI and check proximity
            updateFieldAssignmentInfo(currentVoter);
            checkProximityToCurrentVoter();
        }

        function deselectVoter() {
            if (currentVoter) {
                const prevCard = document.querySelector(`.voter-card[data-voter-id="${currentVoter.id}"]`);
                if (prevCard) prevCard.classList.remove('current');
                updateCurrentVoterMarker(null);
            }
            currentVoter = null;
            updateFieldAssignmentInfo(null);
            checkProximityToCurrentVoter(); // Reset validation display
        }

        function updateCounts() {
            const totalVoters = votersData.length;
            const visitedCount = votersData.filter(v => v.status === 'visited').length;
            document.getElementById('totalVoters').textContent = totalVoters;
            document.getElementById('visitedCount').textContent = visitedCount;
            document.getElementById('listCount').textContent = filteredVoters.length;

            // Field view stats
            const assignedVoters = votersData.filter(v => v.assignedTo === currentUserId);
            const assignedCount = assignedVoters.length;
            const completedCount = assignedVoters.filter(v => v.status === 'visited').length;
            const progress = assignedCount > 0 ? (completedCount / assignedCount) * 100 : 0;
            
            document.getElementById('assignedCount').textContent = assignedCount;
            document.getElementById('fieldVisitedCount').textContent = completedCount;
            document.getElementById('fieldProgressPercent').textContent = `${Math.round(progress)}%`;
        }

        function findNearestVoter() {
            if (!canvasserLocation) {
                showNotification('Cannot find nearest voter. Location not available. Please click "Start Tracking".', 'error');
                return;
            }

            let nearestVoter = null;
            let minDistance = Infinity;

            const assignedVoters = votersData.filter(voter => voter.assignedTo === currentUserId && voter.status !== 'visited');

            if (assignedVoters.length === 0) {
                showNotification('No pending voters in your list.', 'info');
                return;
            }

            assignedVoters.forEach(voter => {
                const distance = calculateDistance(
                    canvasserLocation.lat, canvasserLocation.lng,
                    voter.lat, voter.lng
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestVoter = voter;
                }
            });

            if (nearestVoter) {
                selectVoter(nearestVoter.id);
                showNotification(`Found nearest voter: ${nearestVoter.name} (${(minDistance * 1000).toFixed(0)}m away)`, 'success');
            }
        }

        function updateFieldAssignmentInfo(voter) {
            const currentAssignmentDiv = document.getElementById('currentAssignment');
            const currentVoterInfoDiv = document.getElementById('currentVoterInfo');

            if (voter) {
                currentAssignmentDiv.style.display = 'block';
                currentVoterInfoDiv.innerHTML = `
                    <h6><strong>${voter.name}</strong> <small class="text-muted">(${voter.party})</small></h6>
                    <p class="mb-1">${voter.address}, ${voter.zip}</p>
                    <small>Status: <span class="badge ${voter.status === 'visited' ? 'bg-success' : 'bg-warning'}">${voter.status}</span></small>
                `;
            } else {
                currentAssignmentDiv.style.display = 'none';
                currentVoterInfoDiv.innerHTML = '';
            }
        }

        function markNotHome() {
            if (!currentVoter) {
                showNotification('Please select a voter first.', 'warning');
                return;
            }
            currentVoter.status = 'not-home';
            currentVoter.notes = 'Voter was not home.';
            updateVoter(currentVoter);
            showNotification(`${currentVoter.name} marked as Not Home.`, 'info');
            deselectVoter();
            updateCounts();
        }

        function updateVoter(voter) {
            const index = votersData.findIndex(v => v.id === voter.id);
            if (index !== -1) {
                votersData[index] = voter;
            }
            applyFilters();
            applyModalFilters();
        }

        // Handle form submission
        document.getElementById('notesForm').addEventListener('submit', function(event) {
            event.preventDefault();

            if (!currentVoter) {
                showNotification('Please select a voter before submitting.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn.disabled) {
                showNotification('Form cannot be submitted. You are too far from the voter address.', 'error');
                return;
            }

            // Update voter data with form values
            currentVoter.status = 'visited';
            currentVoter.notes = document.getElementById('voterNotes').value;
            currentVoter.willVote = document.getElementById('willVote').checked;
            currentVoter.present = document.getElementById('present').checked;
            currentVoter.nextTime = document.getElementById('nextTime').checked;
            currentVoter.supportLevel = document.getElementById('supportLevel').value;

            // Save the updated voter data
            updateVoter(currentVoter);
            
            // Clear the form
            document.getElementById('notesForm').reset();
            
            // Notify user and update UI
            showNotification(`Visit for ${currentVoter.name} completed successfully!`, 'success');
            deselectVoter();
            updateCounts();
        });

        function showNotification(message, type) {
            const alertPlaceholder = document.getElementById('messagesPanel');
            const alertContent = document.getElementById('messageContent');
            alertContent.textContent = message;
            alertPlaceholder.style.display = 'block';
            alertPlaceholder.className = `card mb-3 border-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'}`;
            
            setTimeout(() => {
                alertPlaceholder.style.display = 'none';
            }, 5000);
        }

        function dismissMessage() {
            document.getElementById('messagesPanel').style.display = 'none';
        }

        // ========================== ADMIN FUNCTIONS (Simulated) ==========================
        function switchToAdmin() {
            document.body.classList.remove('field-dashboard');
            document.body.classList.add('admin-dashboard');
            isDashboardField = false;
            document.getElementById('fieldBtn').classList.remove('btn-primary');
            document.getElementById('fieldBtn').classList.add('btn-outline-primary');
            document.getElementById('adminBtn').classList.remove('btn-outline-primary');
            document.getElementById('adminBtn').classList.add('btn-primary');
            updateCounts();
            applyFilters();
        }

        function switchToField() {
            document.body.classList.remove('admin-dashboard');
            document.body.classList.add('field-dashboard');
            isDashboardField = true;
            document.getElementById('adminBtn').classList.remove('btn-primary');
            document.getElementById('adminBtn').classList.add('btn-outline-primary');
            document.getElementById('fieldBtn').classList.remove('btn-outline-primary');
            document.getElementById('fieldBtn').classList.add('btn-primary');
            updateCounts();
            applyFieldFilters();
        }

        function assignVotersToWorkers() {
            const totalToAssign = parseInt(document.getElementById('totalToAssign').value);
            const activeWorkers = parseInt(document.getElementById('activeWorkers').value);
            if (isNaN(totalToAssign) || isNaN(activeWorkers) || activeWorkers === 0) {
                showNotification('Invalid input for assignment.', 'error');
                return;
            }

            // Reset all assignments
            votersData.forEach(v => v.assignedTo = null);
            canvassers.forEach(c => c.assignedVoters = []);

            const unassignedVoters = votersData.filter(v => v.status === 'not-visited' && !v.assignedTo).slice(0, totalToAssign);
            
            let workerIndex = 0;
            unassignedVoters.forEach(voter => {
                const worker = canvassers[workerIndex % activeWorkers];
                voter.assignedTo = worker.id;
                worker.assignedVoters.push(voter.id);
                workerIndex++;
            });

            updateCanvasserTracking();
            updateCounts();
            applyFilters();
            showNotification(`${unassignedVoters.length} voters assigned to ${activeWorkers} workers.`, 'success');
        }

        function updateCanvasserTracking() {
            const canvasserTrackingDiv = document.getElementById('canvasserTracking');
            canvasserTrackingDiv.innerHTML = '';
            canvassers.forEach(canvasser => {
                const statusClass = canvasser.status === 'active' ? 'active' : 'inactive';
                const cardHtml = `
                    <div class="card canvasser-tracker ${statusClass}">
                        <div class="card-body p-2">
                            <h6 class="mb-0">
                                <i class="fas fa-user-circle"></i> ${canvasser.name}
                                <span class="badge bg-secondary ms-2">${canvasser.assignedVoters.length} Assigned</span>
                            </h6>
                            <small class="text-muted">Status: ${canvasser.status}</small><br>
                            <small class="text-muted">Last Active: ${canvasser.lastUpdate.toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;
                canvasserTrackingDiv.insertAdjacentHTML('beforeend', cardHtml);
            });
            document.getElementById('activeWorkersCount').textContent = canvassers.filter(c => c.status === 'active').length;
        }

        function sendMessage() {
            const target = document.getElementById('messageTarget').value;
            const message = document.getElementById('messageText').value;
            if (!message) return;
            
            const sender = "Admin";
            const timestamp = new Date().toLocaleTimeString();
            const messageEntry = { sender, message, timestamp, target };
            messageLog.push(messageEntry);
            
            const messageLogDiv = document.getElementById('messageLog');
            messageLogDiv.innerHTML += `
                <div class="border-bottom py-2">
                    <small class="text-muted"><strong>${sender} (${target})</strong> - ${timestamp}</small><br>
                    ${message}
                </div>
            `;
            document.getElementById('messageText').value = '';
            messageLogDiv.scrollTop = messageLogDiv.scrollHeight;
        }

        function generateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            
            const visitedVoters = votersData.filter(v => v.status === 'visited');
            const totalVisited = visitedVoters.length;

            if (totalVisited === 0) {
                summaryContent.innerHTML = `<p class="text-muted">No visits have been completed yet.</p>`;
                return;
            }

            const totalCanvassers = canvassers.length;
            const avgRate = (totalVisited / totalCanvassers);

            const responseBreakdown = visitedVoters.reduce((acc, voter) => {
                if (voter.present) acc.present++;
                if (voter.willVote) acc.willVote++;
                if (voter.nextTime) acc.nextTime++;
                return acc;
            }, { present: 0, willVote: 0, nextTime: 0 });

            const supportBreakdown = visitedVoters.reduce((acc, voter) => {
                if (voter.supportLevel) {
                    acc[voter.supportLevel] = (acc[voter.supportLevel] || 0) + 1;
                }
                return acc;
            }, {});

            const summaryHTML = `
                <div class="row g-2">
                    <div class="col-6">
                        <div class="summary-card">
                            <h6>Total Visits</h6>
                            <h3>${totalVisited}</h3>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="summary-card">
                            <h6>Average Rate</h6>
                            <h3>${avgRate.toFixed(1)}/worker</h3>
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <h6><i class="fas fa-check-circle text-success"></i> Visit Outcomes</h6>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-user-check text-success"></i> Present:</span> 
                            <span><strong>${responseBreakdown.present}</strong> (${Math.round((responseBreakdown.present/totalVisited)*100)}%)</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-vote-yea text-primary"></i> Will Vote:</span> 
                            <span><strong>${responseBreakdown.willVote}</strong> (${Math.round((responseBreakdown.willVote/totalVisited)*100)}%)</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-clock text-warning"></i> Next Time:</span> 
                            <span><strong>${responseBreakdown.nextTime}</strong> (${Math.round((responseBreakdown.nextTime/totalVisited)*100)}%)</span>
                        </div>
                    </div>
                    
                    ${Object.keys(supportBreakdown).length > 0 ? `
                    <div class="col-12">
                        <h6><i class="fas fa-thumbs-up"></i> Support Levels</h6>
                        ${Object.entries(supportBreakdown).map(([level, count]) => `
                            <div class="d-flex justify-content-between">
                                <span>${level.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span> 
                                <span><strong>${count}</strong> (${Math.round((count/totalVisited)*100)}%)</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            `;

            summaryContent.innerHTML = summaryHTML;
        }

        // Initialize modal filters when modal opens
        document.getElementById('voterListModal').addEventListener('shown.bs.modal', function() {
            applyModalFilters();
        });
    </script>
</body>
</html>